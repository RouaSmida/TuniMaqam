<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TuniMaqam | Sonic Heritage Engine</title>
  
  <!-- Typography: Added Fraunces to match the Access Granted page -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,600;1,9..144,300&family=Inter:wght@400;500;600;700&family=Outfit:wght@300;500;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      /* THEME: Sunlit Sidi Bou Said (High Contrast Light Mode) */
      
      --bg-base: #f8fafc;           
      --glass-surface: rgba(255, 255, 255, 0.75); 
      --glass-border: rgba(14, 165, 233, 0.2); 
      --glass-hover: rgba(255, 255, 255, 0.95);
      
      --sidi-blue: #0ea5e9;         
      --sidi-dark-blue: #0369a1;    
      --accent-gold: #f59e0b;       
      --accent-rose: #e11d48;       
      
      --text-main: #0f172a;         
      --text-muted: #475569;        
      
      /* MATCHING LOGIN PAGE FONTS */
      --font-display: 'Fraunces', serif; /* Flexible, soft serif */
      --font-tech: 'Inter', sans-serif;  /* Clean sans-serif */
      
      --ease-elastic: cubic-bezier(0.68, -0.55, 0.265, 1.55);
      --ease-smooth: cubic-bezier(0.4, 0, 0.2, 1);
      
      --shadow-card: 0 10px 30px -10px rgba(14, 165, 233, 0.15);
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      background-color: var(--bg-base);
      color: var(--text-main);
      font-family: var(--font-tech);
      overflow-x: hidden;
      min-height: 100vh;
      background-image: linear-gradient(to bottom, #f0f9ff, #f8fafc);
    }

    /* BACKGROUND FX - THE GRID */
    .grid-overlay {
      position: fixed; inset: 0; z-index: -1;
      background-image: 
        linear-gradient(rgba(14, 165, 233, 0.08) 1px, transparent 1px),
        linear-gradient(90deg, rgba(14, 165, 233, 0.08) 1px, transparent 1px);
      background-size: 40px 40px;
      mask-image: radial-gradient(circle at center, black 40%, transparent 85%);
      -webkit-mask-image: radial-gradient(circle at center, black 40%, transparent 85%);
    }

    .ambient-glow {
      position: fixed; inset: 0; z-index: -2;
      background: 
        radial-gradient(circle at 10% 20%, rgba(14, 165, 233, 0.1), transparent 50%),
        radial-gradient(circle at 90% 80%, rgba(245, 158, 11, 0.08), transparent 50%);
      filter: blur(80px);
    }

    /* HERO IMAGE */
    .hero-bg-img {
      position: absolute;
      top: 0; right: 0;
      width: 60vw; height: 90vh;
      background-size: cover;
      background-position: center left;
      z-index: -1;
      opacity: 0.85; 
      mask-image: linear-gradient(to left, black 30%, transparent 95%), 
                  linear-gradient(to bottom, black 60%, transparent 95%);
      -webkit-mask-image: linear-gradient(to left, black 30%, transparent 95%), 
                          linear-gradient(to bottom, black 60%, transparent 95%);
      mix-blend-mode: multiply;
    }

    /* NAV */
    nav {
      position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
      width: min(90%, 1000px);
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(14, 165, 233, 0.2);
      border-bottom: 2px solid var(--sidi-blue);
      border-radius: 99px;
      padding: 10px 24px;
      display: flex; justify-content: space-between; align-items: center;
      z-index: 100;
      box-shadow: 0 4px 20px rgba(0,0,0,0.05);
    }
    .logo-container {
      display: flex; align-items: center; gap: 12px;
      font-family: var(--font-display);
      font-weight: 700; font-size: 1.4rem;
      letter-spacing: -0.02em;
      color: var(--sidi-dark-blue);
    }
    .logo-svg {
      width: 32px; height: 32px;
      fill: var(--sidi-blue);
    }
    .nav-links { display: flex; gap: 6px; }
    .nav-btn {
      background: transparent;
      border: none; color: var(--text-muted);
      font-family: var(--font-tech);
      font-size: 0.85rem; font-weight: 700; text-transform: uppercase;
      padding: 10px 18px; border-radius: 99px;
      transition: all 0.3s var(--ease-elastic);
      cursor: pointer;
    }
    .nav-btn:hover { color: var(--sidi-dark-blue); background: rgba(14, 165, 233, 0.1); }
    .nav-btn.active {
      color: #fff;
      background: var(--sidi-blue);
      box-shadow: 0 4px 15px rgba(14, 165, 233, 0.3);
    }

    /* LAYOUT */
    main { padding-top: 120px; padding-bottom: 60px; width: min(90%, 1200px); margin: 0 auto; }
    .section { display: none; animation: slideUp 0.6s var(--ease-smooth); }
    .section.active { display: block; }
    @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
    
    h1, h2 { font-family: var(--font-display); font-weight: 600; margin: 0; color: var(--sidi-dark-blue); }
    h2 { 
      font-size: 3rem; margin-bottom: 10px; 
      color: var(--sidi-dark-blue);
    }
    
    .panel-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 24px; }

    /* CARDS */
    .glass-card {
      background: var(--glass-surface);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      padding: 24px;
      position: relative;
      overflow: hidden;
      transition: all 0.2s;
      box-shadow: var(--shadow-card);
      backdrop-filter: blur(12px);
    }
    .glass-card:hover {
      transform: translateY(-4px);
      border-color: var(--sidi-blue);
      background: var(--glass-hover);
      box-shadow: 0 15px 40px -10px rgba(14, 165, 233, 0.25);
    }

    /* FORMS & BUTTONS */
    input, select, textarea {
      width: 100%;
      background: #ffffff;
      border: 1px solid #cbd5e1;
      border-radius: 10px;
      padding: 14px;
      color: var(--text-main);
      font-family: var(--font-tech);
      font-size: 1rem;
      transition: all 0.2s;
      margin-bottom: 12px;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.02);
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--sidi-blue);
      box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.15);
    }
    .btn-action {
      width: 100%;
      padding: 16px;
      border-radius: 10px;
      border: none;
      background: linear-gradient(135deg, var(--sidi-blue), var(--sidi-dark-blue));
      color: #fff;
      font-family: var(--font-tech);
      font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 4px 15px rgba(3, 105, 161, 0.2);
    }
    .btn-action:hover { 
      transform: translateY(-2px); 
      box-shadow: 0 8px 25px rgba(3, 105, 161, 0.3);
    }
    .btn-ghost {
      cursor: pointer;
      background: transparent;
      border: 1px solid #cbd5e1;
      color: var(--text-muted);
      padding: 10px 14px;
      border-radius: 8px;
      font-weight: 700;
      transition: all 0.2s;
    }
    .btn-ghost:hover { 
      color: var(--sidi-dark-blue); 
      border-color: var(--sidi-blue); 
      background: rgba(14, 165, 233, 0.05);
    }

    pre {
      background: #f1f5f9;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 12px;
      color: #334155;
      overflow-x: auto;
      white-space: pre-wrap;
      font-size: 0.9rem;
      margin: 10px 0 0;
    }

    /* Flashcards */
    .flash-deck { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 24px; }
    .magic-card { height: 240px; perspective: 1500px; cursor: pointer; }
    .magic-card:hover { transform: translateY(-4px); }
    .magic-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform-style: preserve-3d; }
    .magic-card.flipped .magic-inner { transform: rotateY(180deg); }
    .magic-face {
      position: absolute; inset: 0;
      backface-visibility: hidden;
      border-radius: 16px;
      border: 1px solid rgba(14, 165, 233, 0.2);
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      padding: 16px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.05);
    }
    .magic-card:hover .magic-face { border-color: var(--sidi-blue); }
    .magic-front { border-bottom: 4px solid var(--accent-gold); }
    .magic-back { transform: rotateY(180deg); background: #fff; border-bottom: 4px solid var(--accent-rose); }

    /* Quiz */
    .quiz-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 16px; margin-top: 12px; transition: transform 0.15s, border-color 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
    .quiz-card:hover { transform: translateY(-2px); border-color: var(--sidi-blue); }
    .quiz-question { font-weight: 700; margin-bottom: 8px; color: var(--sidi-dark-blue); }
    
    /* Visualizer */
    .bar { animation: equalize 1s ease-in-out infinite; width:6px; background:var(--sidi-blue); border-radius:99px; }
    @keyframes equalize { 0%,100% { height: 10px; } 50% { height: 60px; } }

    /* Notifications */
    .toaster { position: fixed; bottom: 30px; right: 30px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
    .toast {
      pointer-events: auto;
      background: #fff; border: 1px solid #e2e8f0;
      padding: 14px 18px; border-radius: 10px;
      display: flex; align-items: center; gap: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      animation: slideInRight 0.4s var(--ease-elastic);
      color: var(--text-main);
    }
    .toast.success { border-left: 4px solid var(--sidi-blue); }
    .toast.error { border-left: 4px solid var(--accent-rose); }
    @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    
    /* Modal */
    .modal {
      position: fixed; inset: 0; display:none; align-items:center; justify-content:center;
      background: rgba(15, 23, 42, 0.4); z-index: 999;
      backdrop-filter: blur(4px);
    }
    .modal.active { display:flex; }
    .modal-content {
      background: #fff; border-radius:16px;
      width: min(700px, 90vw); max-height: 80vh; overflow:auto; padding:24px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }
    .modal-close { float:right; cursor:pointer; color: var(--text-muted); font-weight:bold; font-size: 1.2rem; }
  </style>
</head>
<body>

  <div class="ambient-glow"></div>
  <div class="grid-overlay"></div>

  <nav>
    <div class="logo-container">
      <svg class="logo-svg" viewBox="0 0 100 100">
        <path d="M50 10 C30 10 10 30 10 50 C10 70 30 90 50 90 C70 90 90 70 90 50 C90 30 70 10 50 10 Z M50 20 C65 20 80 35 80 50 C80 65 65 80 50 80 C35 80 20 65 20 50 C20 35 35 20 50 20 Z" opacity="0.5" />
        <circle cx="50" cy="50" r="15" />
        <path d="M50 0 L50 100 M0 50 L100 50" stroke="currentColor" stroke-width="2" />
      </svg>
      <span>TuniMaqam</span>
    </div>
    <div class="nav-links">
      <button class="nav-btn active" onclick="route(event,'dashboard')">Home</button>
      <button class="nav-btn" onclick="route(event,'knowledge')">Archive</button>
      <button class="nav-btn" onclick="route(event,'analysis')">Inference</button>
      <button class="nav-btn" onclick="route(event,'learning')">Academy</button>
    </div>
  </nav>

  <main>
    <!-- DASHBOARD SECTION -->
    <section id="dashboard" class="section active" style="position:relative;">
      <!-- THE SIDI BOU SCENIC VIEW -->
      <div class="hero-bg-img"></div>
      
      <header style="text-align:center; margin-bottom: 60px; max-width: 100%;">
        <h1
          style="
            /* USING FRAUNCES TO MATCH LOGIN PAGE */
            font-family: var(--font-display); 
            font-size: 5.5rem;
            letter-spacing: -2px;
            line-height: 0.95;
            margin-bottom: 20px;
            color: #0f172a;
            font-weight: 300; 
          "
        >
          PRESERVE<br>
          <span style="color:var(--sidi-blue); font-weight: 300;">
            THE RESONANCE
          </span>
        </h1>
        <p
          style="
            font-size: 1.2rem;
            max-width: 600px;
            margin: 0 auto;
            color: var(--text-muted);
            font-weight:500;
          "
        >
          Modular API Ecosystem for Tunisian Maqamet (ṭbūʿ)<br> 
          A crowdsourced patrimony intelligence engine.
        </p>
      </header>

      <div class="panel-container">
        <!-- Auth Panel -->
        <div class="glass-card">
          <h2 style="font-size:2.2rem; margin-bottom:16px;">System Access</h2>
          <div style="display:flex; gap: 12px; align-items:center; flex-wrap: wrap;">
             <input id="token" placeholder="Paste JWT here..." style="margin-bottom:0; flex:1 1 240px;" />
             <button class="btn-action" style="width: auto;" onclick="handleAuth()">Initialize</button>
          </div>
          <div id="auth-status" style="margin-top: 15px; font-weight:600; color: var(--text-muted);">Awaiting Connection...</div>
        </div>

        <!-- Stats Panel -->
        <div class="glass-card">
          <h2 style="font-size:2rem; margin-bottom:16px;">Database Health</h2>
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
             <div style="text-align:center; padding:16px; background:rgba(255,255,255,0.6); border-radius:12px; border:1px solid #e2e8f0;">
               <div style="font-size:2.5rem; font-weight:700; color:var(--sidi-dark-blue); line-height:1;" id="stat-maqam">0</div>
               <div style="font-size:0.75rem; text-transform:uppercase; color:var(--text-muted); margin-top:4px;">Maqamet</div>
             </div>
             <div style="text-align:center; padding:16px; background:rgba(255,255,255,0.6); border-radius:12px; border:1px solid #e2e8f0;">
               <div style="font-size:2.5rem; font-weight:700; color:var(--accent-rose); line-height:1;" id="stat-contrib">0</div>
               <div style="font-size:0.75rem; text-transform:uppercase; color:var(--text-muted); margin-top:4px;">Contribs</div>
             </div>
          </div>
          <button onclick="refreshStats()" class="btn-ghost" style="margin-top:12px; width:100%;">Refresh Nodes</button>
        </div>
      </div>
    </section>

    <!-- KNOWLEDGE SECTION -->
    <section id="knowledge" class="section">
      <div style="display:flex; justify-content:space-between; align-items:end; margin-bottom: 24px; gap:12px; flex-wrap:wrap;">
        <div>
           <h2 style="font-size: 3rem; margin-bottom:0;">Sonic Cartography</h2>
           <p style="color:var(--text-muted);">The definitive archive of Tunisian scales.</p>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
           <input id="search-input" placeholder="Search (e.g. Sika)" style="width: 200px; margin-bottom:0;" />
           <input id="region-input" placeholder="Region filter (optional)" style="width: 200px; margin-bottom:0;" />
           <button class="btn-action" style="width:auto; padding: 12px 20px;" onclick="searchMaqam()">Scan</button>
           <button class="btn-ghost" style="width:auto; padding: 12px 20px;" onclick="loadRegions()">Regions</button>
        </div>
      </div>
      <div id="regions-panel" class="glass-card" style="display:none; margin-bottom:20px;"></div>
      <div id="maqam-grid" class="panel-container"></div>
    </section>

    <!-- ANALYSIS SECTION -->
    <section id="analysis" class="section">
       <div class="panel-container">
         <div class="glass-card">
            <h2 style="font-size:2.5rem;">Input Stream</h2>
            <p style="margin-bottom:20px; color:var(--text-muted);">Enter note sequence for interval pattern matching.</p>
            <label style="font-weight:700; color:var(--sidi-dark-blue);">Sequence</label>
            <input id="an-notes" value="C, D, E, F, G" />
            <label style="font-weight:700; color:var(--sidi-dark-blue);">Context (Optional)</label>
            <input id="an-mood" placeholder="e.g. Nostalgic" />
            <button class="btn-action" onclick="runAnalysis()">Process Audio Data</button>
         </div>

         <div class="glass-card" style="background: #fff; border-color: var(--sidi-blue);">
            <div id="visualizer" style="display:flex; gap:6px; height:100px; align-items:center; justify-content:center; opacity:0.8; transition:0.3s; margin-bottom:10px;">
              <div class="bar" style="animation-delay: 0.1s; background:var(--sidi-blue);"></div>
              <div class="bar" style="animation-delay: 0.3s; background:var(--accent-rose);"></div>
              <div class="bar" style="animation-delay: 0.5s; background:var(--accent-gold);"></div>
              <div class="bar" style="animation-delay: 0.2s; background:var(--sidi-dark-blue);"></div>
              <div class="bar" style="animation-delay: 0.4s; background:#cbd5e1;"></div>
            </div>
            <div id="analysis-output" style="min-height: 220px; padding: 16px; border-top: 1px solid #e2e8f0;">
              <div style="text-align:center; color: #94a3b8; padding-top: 40px;">Waiting for signal...</div>
            </div>
         </div>
       </div>

       <div class="panel-container" style="margin-top:24px;">
         <div class="glass-card" style="grid-column: span 2;">
          <h2 style="font-size:2.5rem;">Recommendations</h2>
           <div style="display:grid; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); gap:12px; margin-bottom:16px;">
             <input id="rec-mood" placeholder="mood (optional)" />
             <input id="rec-event" placeholder="event (optional)" />
             <input id="rec-region" placeholder="region (optional)" />
             <input id="rec-season" placeholder="season (optional)" />
             <input id="rec-timeperiod" placeholder="time_period (optional)" />
             <label style="display:flex; align-items:center; gap:8px; color:var(--text-main); font-weight:500;">
               <input type="checkbox" id="rec-heritage" style="width:auto; margin:0; accent-color:var(--sidi-blue);"> preserve_heritage
             </label>
             <label style="display:flex; align-items:center; gap:8px; color:var(--text-main); font-weight:500;">
               <input type="checkbox" id="rec-simple" style="width:auto; margin:0; accent-color:var(--sidi-blue);"> simple_for_beginners
             </label>
           </div>
           <button class="btn-action" style="width:auto; padding:12px 24px;" onclick="runRecommendation()">Run Recommendation</button>
           <div id="rec-output" style="margin-top:16px;"></div>
         </div>
       </div>
    </section>

    <!-- LEARNING SECTION -->
    <section id="learning" class="section">
      <header style="margin-bottom: 24px; border-bottom: 1px solid #e2e8f0; padding-bottom: 16px;">
        <h2 style="font-size:2.8rem;">The Academy</h2>

        <div style="display:flex; gap: 10px; flex-wrap:wrap;">
           <select id="flash-topic" style="width: auto; margin:0;">
             <option value="emotion">Emotion</option>
             <option value="region">Region</option>
             <option value="usage">Usage</option>
           </select>
           <button class="btn-action" style="width:auto; padding: 10px 24px;" onclick="loadFlashcards()">Load Holo-Deck</button>
        </div>
      </header>

      <div id="flash-grid" class="flash-deck"></div>

      <div class="glass-card" style="margin-top:30px;">
        <h3 style="margin-top:0; font-size:1.5rem; color:var(--sidi-dark-blue);">Quiz Station</h3>
        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:16px;">
          <select id="quiz-topic" style="width:auto; margin:0;">
            <option value="emotion">Emotion</option>
            <option value="region">Region</option>
            <option value="usage">Usage</option>
          </select>
          <select id="quiz-level" style="width:auto; margin:0;">
            <option value="beginner">Beginner</option>
            <option value="intermediate">Intermediate</option>
            <option value="advanced">Advanced</option>
          </select>
          <button class="btn-action" style="width:auto; padding: 10px 20px;" onclick="startQuiz()">Start Quiz</button>
        </div>
        <div id="quiz-container"></div>
      </div>
    </section>
  </main>

  <!-- Modal for details/contributions -->
  <div class="modal" id="modal">
    <div class="modal-content">
      <span class="modal-close" onclick="closeModal()">✕</span>
      <div id="modal-body"></div>
    </div>
  </div>

  <div class="toaster" id="toaster"></div>

  <script>
    const STORE_KEY = 'tuni_jwt_v2';
    let currentQuiz = null;

    function notify(msg, type='success') {
      const toaster = document.getElementById('toaster');
      const el = document.createElement('div');
      el.className = `toast ${type}`;
      el.innerHTML = `<span style="font-weight:700;">${msg}</span>`;
      toaster.appendChild(el);
      setTimeout(() => {
        el.style.opacity = '0';
        el.style.transform = 'translateX(100%)';
        setTimeout(() => el.remove(), 300);
      }, 4000);
    }

    function route(ev, id) {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      if (ev && ev.target) ev.target.classList.add('active');
    }

    async function api(endpoint, method='GET', body=null) {
      const token = localStorage.getItem(STORE_KEY);
      const headers = { 'Content-Type': 'application/json' };
      if (token) headers['Authorization'] = `Bearer ${token}`;
      const res = await fetch(endpoint, { method, headers, body: body ? JSON.stringify(body) : null });
      let json = {};
      try { json = await res.json(); } catch (_) {}
      if (!res.ok) throw new Error(json.error || res.statusText || 'System error');
      return json;
    }

    function handleAuth() {
      const val = document.getElementById('token').value.trim();
      if (!val) return notify('Token Required', 'error');
      localStorage.setItem(STORE_KEY, val);
      checkAuth();
      notify('Secure Connection Established');
    }
    function checkAuth() {
      const t = localStorage.getItem(STORE_KEY);
      const status = document.getElementById('auth-status');
      if (t) {
        try {
          const p = JSON.parse(atob(t.split('.')[1]));
          status.innerHTML = `<span style="color:var(--sidi-blue)">● ONLINE</span> | User: ${p.role || 'Unknown'}`;
        } catch {
          status.innerHTML = `<span style="color:var(--accent-rose)">● CORRUPT TOKEN</span>`;
        }
      } else {
        status.innerHTML = `<span style="color:#94a3b8">○ OFFLINE</span>`;
      }
    }

    async function refreshStats() {
      try {
        const d = await api('/status');
        animateValue("stat-maqam", 0, d.maqamet_count, 800);
        animateValue("stat-contrib", 0, d.contributions_count, 800);
      } catch(e) { notify(e.message, 'error'); }
    }
    function animateValue(id, start, end, duration) {
      const obj = document.getElementById(id);
      let startTimestamp = null;
      const step = (timestamp) => {
        if (!startTimestamp) startTimestamp = timestamp;
        const progress = Math.min((timestamp - startTimestamp) / duration, 1);
        obj.innerHTML = Math.floor(progress * (end - start) + start);
        if (progress < 1) window.requestAnimationFrame(step);
      };
      window.requestAnimationFrame(step);
    }

    /* Modal helpers */
    function openModal(html) {
      document.getElementById('modal-body').innerHTML = html;
      document.getElementById('modal').classList.add('active');
    }
    function closeModal() {
      document.getElementById('modal').classList.remove('active');
      document.getElementById('modal-body').innerHTML = '';
    }

    /* Knowledge */
    async function searchMaqam() {
      const q = document.getElementById('search-input').value.trim();
      const region = document.getElementById('region-input').value.trim();
      let url = '/knowledge/maqam';
      if (q) url = `/knowledge/maqam/by-name/${encodeURIComponent(q)}`;
      else if (region) url = `/knowledge/maqam?region=${encodeURIComponent(region)}`;

      const grid = document.getElementById('maqam-grid');
      grid.innerHTML = '<div style="color:#64748b; font-weight:500;">Scanning database...</div>';
      try {
        let d = await api(url);
        if (!Array.isArray(d)) d = [d];
        grid.innerHTML = '';
        if (d.length === 0) grid.innerHTML = 'No Data Found';
        d.forEach(m => {
          const regionsEn = (m.regions && (m.regions.en || m.regions).join ? (m.regions.en || m.regions).join(' / ') : '');
          const regionsAr = (m.regions && Array.isArray(m.regions.ar)) ? m.regions.ar.join(' / ') : '';
          const descEn = (m.descriptions && m.descriptions.en) ? m.descriptions.en : (m.description?.en || '');
          const descAr = (m.descriptions && m.descriptions.ar) ? m.descriptions.ar : (m.description?.ar || '');
          const nameEn = m.name_en || m.name?.en || 'Unknown';
          const nameAr = m.name_ar || m.name?.ar || '';

          const div = document.createElement('div');
          div.className = 'glass-card';
          div.innerHTML = `
            <div style="display:flex; justify-content:space-between; gap:8px; align-items:center;">
              <div>
                <h3 style="font-family:var(--font-display); font-size:1.4rem; color:var(--sidi-dark-blue); margin:0;">${nameEn}</h3>
                ${nameAr ? `<div style="font-size:0.95rem; color:var(--text-muted); direction:rtl; text-align:right;">${nameAr}</div>` : ''}
              </div>
              <span style="border:1px solid var(--sidi-blue); color:var(--sidi-blue); padding:4px 8px; border-radius:6px; font-size:0.75rem; font-weight:600;">ID ${m.id||''}</span>
            </div>
            <p style="color:var(--text-main); margin-top:12px; line-height:1.5;">${(descEn||'No Data').substring(0,120)}...</p>
            ${descAr ? `<p style="color:var(--text-muted); font-size:0.9rem; margin-top:4px; direction:rtl; text-align:right;">${descAr.substring(0,80)}...</p>` : ''}
            <div style="margin-top:16px; display:flex; gap:6px; flex-wrap:wrap;">
              <button class="btn-ghost" style="padding:6px 12px; font-size:0.8rem;" onclick="showDetail(${m.id})">Detail</button>
              <button class="btn-ghost" style="padding:6px 12px; font-size:0.8rem;" onclick="showRelated('${nameEn}')">Related</button>
              <button class="btn-ghost" style="padding:6px 12px; font-size:0.8rem;" onclick="showContribs(${m.id})">Contributions</button>
              <button class="btn-ghost" style="padding:6px 12px; font-size:0.8rem;" onclick="openContribForm(${m.id})">Add Contribution</button>
            </div>
            <div style="margin-top:12px; font-size:0.85rem; color:var(--text-muted); border-top:1px solid #e2e8f0; padding-top:8px;">
               <span style="color:var(--sidi-dark-blue); font-weight:700;">Origin:</span> ${regionsEn || '—'}
               ${regionsAr ? `<div style="color:var(--text-muted); direction:rtl; text-align:right;">${regionsAr}</div>` : ''}
            </div>
          `;
          grid.appendChild(div);
        });
      } catch(e) { notify(e.message, 'error'); }
    }

    async function loadRegions() {
      const panel = document.getElementById('regions-panel');
      panel.style.display = 'block';
      panel.innerHTML = 'Loading regions...';
      try {
        const data = await api('/knowledge/regions');
        panel.innerHTML = data.map(r => {
          const names = (r.maqamet || []).map(x => x.name_en || x.name?.en || '').join(' • ');
          const namesAr = (r.maqamet || []).map(x => x.name_ar || x.name?.ar || '').filter(Boolean).join(' • ');
          return `<div style="margin-bottom:8px;">
                    <strong style="color:var(--accent-gold)">${r.region}</strong>:
                    <span style="color:var(--text-muted)">${names || '—'}</span>
                    ${namesAr ? `<div style="color:var(--text-muted); direction:rtl; text-align:right; font-size:0.85rem;">${namesAr}</div>` : ''}
                  </div>`;
        }).join('') || 'No regions found';
      } catch(e) {
        panel.innerHTML = 'Failed to load regions';
        notify(e.message, 'error');
      }
    }

    async function showDetail(id) {
      try {
        const d = await api(`/knowledge/maqam/${id}`);

        const nameEn = d.name_en || d.name?.en || 'Unknown';
        const nameAr = d.name_ar || d.name?.ar || '';
        const descEn = d.descriptions?.en || d.description?.en || '';
        const descAr = d.descriptions?.ar || d.description?.ar || '';
        const regionsEn = (d.regions?.en || []).join(' / ');
        const usageEn = (d.usage?.en || []).join(' · ');
        const usageAr = (d.usage?.ar || []).join(' · ');
        const emotionEn = d.emotion?.en || d.emotion || '';
        const emotionAr = d.emotion?.ar || '';
        const difficulty = d.difficulty_label?.en || d.difficulty_label || '';
        const rarity = d.rarity_level?.en || d.rarity_level || '';

        const ajnas = Array.isArray(d.ajnas) ? d.ajnas : [];

        const audioHtml = d.audio_url
          ? `<h4 style="margin-top:16px; margin-bottom:8px; color:var(--sidi-dark-blue);">Audio Sample</h4>
             <div style="background:#f8fafc; border-radius:12px; padding:12px; border:1px solid #e2e8f0;">
               <audio controls style="width:100%;">
                 <source src="${d.audio_url}" type="audio/mpeg">
                 Your browser does not support the audio element.
               </audio>
             </div>`
          : `<p style="color:var(--text-muted); margin-top:8px;">No audio clip attached yet.</p>`;

        const ajnasHtml = ajnas.length
          ? ajnas.map(j => {
              const jNameEn = j.name?.en || '';
              const jNameAr = j.name?.ar || '';
              const notesEn = (j.notes?.en || []).join(' – ');
              const notesAr = (j.notes?.ar || []).join(' – ');
              return `
                <div style="padding:10px 12px; border-radius:10px; background:#f1f5f9; margin-bottom:8px; border:1px solid #e2e8f0;">
                  <div style="display:flex; justify-content:space-between; font-size:0.95rem;">
                    <span style="color:var(--sidi-dark-blue); font-weight:700;">${jNameEn}</span>
                    <span style="color:var(--text-muted); direction:rtl; text-align:right;">${jNameAr}</span>
                  </div>
                  <div style="margin-top:6px; font-size:0.85rem; color:var(--text-muted);">
                    <div><strong>EN:</strong> ${notesEn || '—'}</div>
                    <div style="direction:rtl; text-align:right;"><strong>AR:</strong> ${notesAr || '—'}</div>
                  </div>
                </div>`;
            }).join('')
          : '<p style="color:var(--text-muted); font-size:0.85rem;">No ajnas metadata.</p>';

        const metaPill = (label, value, color) =>
          value
            ? `<span style="border-radius:999px; padding:4px 12px; font-size:0.75rem; border:1px solid ${color}; color:${color}; margin-right:6px; font-weight:600; background:rgba(255,255,255,0.8);">
                 ${label}: ${value}
               </span>`
            : '';

        openModal(`
          <div style="display:flex; flex-direction:column; gap:16px;">
            <div>
              <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
                <h3 style="margin:0; font-family:var(--font-display); font-size:1.8rem; color:var(--sidi-dark-blue);">
                  ${nameEn}
                </h3>
                ${nameAr ? `<span style="font-size:1.1rem; color:var(--text-muted); direction:rtl; text-align:right;">${nameAr}</span>` : ''}
              </div>
              <div style="margin-top:12px;">
                ${metaPill('Emotion', emotionEn, 'var(--accent-rose)')}
                ${metaPill('Difficulty', difficulty, 'var(--sidi-blue)')}
                ${metaPill('Rarity', rarity, 'var(--accent-gold)')}
              </div>
            </div>

            ${audioHtml}

            <div style="display:grid; grid-template-columns: minmax(0,2fr) minmax(0,1.5fr); gap:20px; margin-top:12px;">
              <div style="background:#f8fafc; padding:16px; border-radius:12px; border:1px solid #e2e8f0;">
                <h4 style="margin:0 0 8px; color:var(--sidi-dark-blue);">Narrative</h4>
                <p style="margin:0 0 8px; color:var(--text-main); font-size:0.95rem; line-height:1.6;">${descEn || 'No description.'}</p>
                ${descAr ? `<p style="margin:0; color:var(--text-muted); font-size:0.9rem; direction:rtl; text-align:right;">${descAr}</p>` : ''}
              </div>

              <div style="background:#f8fafc; padding:16px; border-radius:12px; border:1px solid #e2e8f0; font-size:0.9rem;">
                <h4 style="margin:0 0 8px; color:var(--sidi-dark-blue);">Meta</h4>
                <div><strong style="color:var(--sidi-blue);">Origin:</strong> ${regionsEn || '—'}</div>
                <div style="margin-top:6px;"><strong style="color:var(--sidi-blue);">Usage (EN):</strong> ${usageEn || '—'}</div>
                <div style="margin-top:4px; color:var(--text-muted);"><strong>Usage (AR):</strong> ${usageAr || '—'}</div>
                <div style="margin-top:6px;"><strong style="color:var(--sidi-blue);">Emotion (AR):</strong> ${emotionAr || '—'}</div>
              </div>
            </div>

            <div style="background:#fff; padding:0; border-radius:12px; margin-top:8px;">
              <h4 style="margin:0 0 10px; color:var(--sidi-dark-blue);">Ajnas structure</h4>
              ${ajnasHtml}
            </div>

            <details style="margin-top:10px; font-size:0.8rem;">
              <summary style="cursor:pointer; color:var(--text-muted);">Developer raw JSON</summary>
              <pre style="margin-top:6px;">${JSON.stringify(d, null, 2)}</pre>
            </details>
          </div>
        `);
      } catch (e) {
        notify(e.message, 'error');
      }
    }

    async function showRelated(nameEn) {
      if (!nameEn) return notify('No name provided', 'error');
      try {
        const d = await api(`/knowledge/maqam/${encodeURIComponent(nameEn)}/related`);
        const base = d.base || {};
        const related = d.related || [];

        const baseTitle = base.name_en || base.name?.en || nameEn;
        const baseTitleAr = base.name_ar || base.name?.ar || '';
        const baseRegions = (base.regions?.en || []).join(' / ');
        const baseEmotion = base.emotion?.en || base.emotion || '';
        const baseDifficulty = base.difficulty_label?.en || base.difficulty_label || '';

        const cardsHtml = related.length
          ? related.map(m => {
              const title = m.name_en || m.name?.en || 'Unknown';
              const titleAr = m.name_ar || m.name?.ar || '';
              const regions = (m.regions?.en || []).join(' / ');
              const regionsAr = (m.regions?.ar || []).join(' / ');
              const emotion = m.emotion?.en || m.emotion || '';
              const diff = m.difficulty_label?.en || m.difficulty_label || '';
              const desc = (m.descriptions?.en || '').substring(0, 120);
              const descAr = (m.descriptions?.ar || '').substring(0, 80);

              return `
                <div class="glass-card" style="margin-bottom:12px; padding:16px;">
                  <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
                    <div>
                      <div style="font-family:var(--font-display); color:var(--sidi-dark-blue); font-size:1.2rem;">${title}</div>
                      ${titleAr ? `<div style="font-size:0.95rem; color:var(--text-muted); direction:rtl; text-align:right;">${titleAr}</div>` : ''}
                      <div style="font-size:0.85rem; color:var(--text-muted); margin-top:2px;">${regions || '—'}</div>
                      ${regionsAr ? `<div style="font-size:0.85rem; color:var(--text-muted); direction:rtl; text-align:right;">${regionsAr}</div>` : ''}
                    </div>
                    <div style="text-align:right; font-size:0.8rem; color:var(--text-muted);">
                      ${emotion ? `<div>Emotion: <span style="color:var(--accent-rose); font-weight:600;">${emotion}</span></div>` : ''}
                      ${diff ? `<div>Level: <span style="color:var(--sidi-blue); font-weight:600;">${diff}</span></div>` : ''}
                    </div>
                  </div>
                  <p style="margin:10px 0 0; font-size:0.95rem; color:var(--text-main); line-height:1.5;">${desc || 'No summary.'}</p>
                  ${descAr ? `<p style="margin:6px 0 0; font-size:0.9rem; color:var(--text-muted); direction:rtl; text-align:right;">${descAr}...</p>` : ''}
                  <button class="btn-ghost" style="margin-top:12px; padding:8px 14px;" onclick="showDetail(${m.id})">
                    View detail
                  </button>
                </div>`;
            }).join('')
          : '<p style="color:var(--text-muted); font-size:0.9rem;">No related maqamet found.</p>';

        openModal(`
          <div style="display:flex; flex-direction:column; gap:16px;">
            <div>
              <h3 style="margin:0; font-family:var(--font-display); font-size:1.6rem; color:var(--sidi-dark-blue);">
                Related to ${baseTitle}
              </h3>
              ${baseTitleAr ? `<div style="font-size:1rem; color:var(--text-muted); direction:rtl; text-align:right;">${baseTitleAr}</div>` : ''}
              <div style="margin-top:8px; font-size:0.9rem; color:var(--text-muted);">
                ${baseRegions ? `<span style="margin-right:12px;">Origin: <span style="color:var(--sidi-blue); font-weight:600;">${baseRegions}</span></span>` : ''}
                ${baseEmotion ? `<span style="margin-right:12px;">Emotion: <span style="color:var(--accent-rose); font-weight:600;">${baseEmotion}</span></span>` : ''}
                ${baseDifficulty ? `<span>Level: <span style="color:var(--sidi-dark-blue); font-weight:600;">${baseDifficulty}</span></span>` : ''}
              </div>
            </div>

            <div style="max-height:60vh; overflow:auto; padding-right:4px;">
              ${cardsHtml}
            </div>
          </div>
        `);
      } catch (e) {
        notify(e.message, 'error');
      }
    }

    async function showContribs(id) {
      try {
        const d = await api(`/knowledge/maqam/${id}/contributions`);
        const list = Array.isArray(d) ? d : (d.items || []);

        const itemsHtml = list.length
          ? list.map(c => {
              const status = c.status || 'pending';
              const created = c.created_at || c.created || '';
              const type = c.type || 'unknown';
              const payloadPreview = JSON.stringify(c.payload || {}, null, 2).substring(0, 260);

              const statusColor =
                status === 'approved' ? 'var(--sidi-blue)' :
                status === 'rejected' ? 'var(--accent-rose)' :
                'var(--accent-gold)';

              return `
                <div class="glass-card" style="margin-bottom:12px; padding:16px;">
                  <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
                    <div style="font-size:0.9rem;">
                      <div style="font-weight:700; color:var(--sidi-dark-blue);">Contribution #${c.id || '?'}</div>
                      <div style="color:var(--text-muted);">Type: ${type}</div>
                    </div>
                    <div style="text-align:right; font-size:0.85rem; color:var(--text-muted);">
                      <div>Status: <span style="color:${statusColor}; text-transform:uppercase; font-weight:700;">${status}</span></div>
                      ${created ? `<div>${created}</div>` : ''}
                    </div>
                  </div>
                  <pre style="margin-top:10px; max-height:120px; overflow:auto; font-size:0.85rem;">${payloadPreview}</pre>
                </div>`;
            }).join('')
          : '<p style="color:var(--text-muted); font-size:0.95rem;">No contributions recorded yet.</p>';

        openModal(`
          <div style="display:flex; flex-direction:column; gap:16px;">
            <div>
              <h3 style="margin:0; font-family:var(--font-display); font-size:1.6rem; color:var(--sidi-dark-blue);">
                Contributions · ID ${id}
              </h3>
              <p style="margin:6px 0 0; font-size:0.95rem; color:var(--text-muted);">
                Community-submitted corrections, regional data, and anecdotes for this maqam.
              </p>
            </div>

            <div style="max-height:60vh; overflow:auto; padding-right:4px;">
              ${itemsHtml}
            </div>
          </div>
        `);
      } catch (e) {
        notify(e.message, 'error');
      }
    }

    function openContribForm(id) {
      const html = `
        <div style="display:flex; flex-direction:column; gap:16px;">
          <div>
            <h3 style="margin:0; font-family:var(--font-display); font-size:1.6rem; color:var(--sidi-dark-blue);">
              Add Contribution · ID ${id}
            </h3>
            <p style="margin:6px 0 0; font-size:0.95rem; color:var(--text-muted);">
              Propose new regional data, usage, corrections, or anecdotes for this maqam.
            </p>
          </div>

          <div class="glass-card" style="padding:20px; background:#f8fafc;">
            <label style="font-size:0.9rem; font-weight:600; color:var(--text-main);">
              Type
              <span style="color:var(--text-muted); font-weight:400; font-size:0.85rem;">
                (e.g. region_add, usage_add, correction, anecdote)
              </span>
            </label>
            <input id="contrib-type" placeholder="e.g. region_add" />

            <label style="font-size:0.9rem; font-weight:600; color:var(--text-main); margin-top:8px; display:block;">
              Payload JSON
            </label>
            <textarea id="contrib-payload" rows="6" style="font-family:monospace;">
{
  "note": "example payload"
}
            </textarea>

            <div style="margin-top:8px; font-size:0.8rem; color:var(--text-muted);">
              Tip: Make sure the payload is valid JSON.
            </div>

            <div style="display:flex; justify-content:flex-end; gap:12px; margin-top:16px;">
              <button class="btn-ghost" onclick="closeModal()" style="padding:10px 18px;">Cancel</button>
              <button class="btn-action" style="width:auto; padding:10px 24px;" onclick="submitContribution(${id})">
                Submit Contribution
              </button>
            </div>
          </div>
        </div>
      `;
      openModal(html);
    }

    async function submitContribution(id) {
      const type = document.getElementById('contrib-type').value.trim();
      const payloadRaw = document.getElementById('contrib-payload').value;
      if (!type) return notify('Type required', 'error');

      let payload;
      try {
        payload = JSON.parse(payloadRaw || '{}');
      } catch {
        return notify('Invalid JSON payload', 'error');
      }

      try {
        await api(`/knowledge/maqam/${id}/contributions`, 'POST', { type, payload });
        notify('Contribution submitted');
        closeModal();
      } catch (e) {
        notify(e.message, 'error');
      }
    }

    /* Analysis */
    async function runAnalysis() {
      const notes = document.getElementById('an-notes').value.split(',').map(x => x.trim()).filter(Boolean);
      const mood = document.getElementById('an-mood').value.trim();
      const viz = document.getElementById('visualizer');
      const out = document.getElementById('analysis-output');
      viz.style.opacity = 1;
      out.innerHTML = '<div style="color:var(--sidi-blue); font-weight:600;">Computing...</div>';
      try {
        const d = await api('/analysis/notes', 'POST', { notes, optional_mood: mood });
        setTimeout(() => {
          viz.style.opacity = 0.5;
          out.innerHTML = '';
          if (d.candidates && d.candidates.length) {
            d.candidates.forEach(c => {
              const pct = Math.round((c.confidence || 0) * 100);

              const nameEn = c.maqam_en || c.maqam?.en || c.maqam || '';
              const nameAr = c.maqam_ar || c.maqam?.ar || '';
              const reason = c.reason || '';

              out.innerHTML += `
                <div style="margin-bottom:16px; border-left:3px solid var(--sidi-blue); padding-left:16px;">
                  <div style="display:flex; justify-content:space-between;">
                    <div>
                      <strong style="font-size:1.1rem; color:var(--sidi-dark-blue);">${nameEn}</strong>
                      ${nameAr ? `<div style="font-size:0.95rem; color:var(--text-muted); direction:rtl; text-align:right;">${nameAr}</div>` : ''}
                    </div>
                    <span style="color:var(--sidi-blue); font-weight:700;">${pct}% Probability</span>
                  </div>
                  <p style="color:#64748b; font-size:0.95rem; margin-top:6px; line-height:1.5;">${reason || ''}</p>
                </div>
              `;
            });
          } else {
            out.innerHTML = '<div style="color:var(--text-muted)">No matches found.</div>';
          }
        }, 500);
      } catch (e) {
        viz.style.opacity = 0.5;
        out.innerHTML = '<div style="color:var(--accent-rose)">Error running analysis</div>';
      }
    }

    /* Recommendations */
    async function runRecommendation() {
      const body = {
        mood: document.getElementById('rec-mood').value.trim() || null,
        event: document.getElementById('rec-event').value.trim() || null,
        region: document.getElementById('rec-region').value.trim() || null,
        season: document.getElementById('rec-season').value.trim() || null,
        time_period: document.getElementById('rec-timeperiod').value.trim() || null,
        preserve_heritage: document.getElementById('rec-heritage').checked,
        simple_for_beginners: document.getElementById('rec-simple').checked
      };
      const out = document.getElementById('rec-output');
      out.innerHTML = 'Computing...';
      try {
        const d = await api('/recommendations/maqam', 'POST', body);
        out.innerHTML = (d.recommendations || []).map(r => {
          const nameEn = r.maqam || '';
          const nameAr = r.maqam_ar || '';
          const reason = r.reason || '';
          const pct = Math.round((r.confidence || 0) * 100);

          return `
            <div style="margin-bottom:16px; border-left:3px solid var(--sidi-blue); padding-left:14px;">
              <div style="display:flex; justify-content:space-between;">
                <div>
                  <strong style="color:var(--sidi-dark-blue);">${nameEn}</strong>
                  ${nameAr ? `<div style="font-size:0.9rem; color:var(--text-muted); direction:rtl; text-align:right;">${nameAr}</div>` : ''}
                </div>
                <span style="color:var(--sidi-blue); font-weight:700;">${pct}%</span>
              </div>
              <div style="color:var(--text-muted); font-size:0.95rem; margin-top:6px; line-height:1.5;">${reason}</div>
            </div>
          `;
        }).join('') || 'No recommendations';
      } catch (e) {
        out.innerHTML = 'Error';
        notify(e.message, 'error');
      }
    }

    /* Flashcards */
    async function loadFlashcards() {
      const topic = document.getElementById('flash-topic').value;
      const grid = document.getElementById('flash-grid');
      grid.innerHTML = 'Loading Holo-Deck...';
      try {
        const d = await api(`/learning/flashcards?topic=${topic}`);
        grid.innerHTML = '';
        if (d.cards) {
          d.cards.forEach(c => {
            const nameEn = c.name_en || c.front || '';
            const nameAr = c.name_ar || '';

            // English back
            const backEn = Array.isArray(c.back) ? c.back.join(', ') : (c.back || '');

            let backAr = '';
            if (topic === 'emotion') {
              backAr = c.emotion_ar || '';
            } else if (topic === 'region') {
              const regionsAr = Array.isArray(c.regions_ar)
                ? c.regions_ar.join(' ، ')
                : (c.regions_ar || '');
              backAr = regionsAr;
            } else if (topic === 'usage') {
              if (Array.isArray(c.usage_ar_list)) {
                backAr = c.usage_ar_list.join(' ، ');
              } else {
                backAr = c.usage_ar || '';
              }
            }

            const el = document.createElement('div');
            el.className = 'magic-card';
            el.onclick = () => el.classList.toggle('flipped');
            el.innerHTML = `
              <div class="magic-inner">
                <div class="magic-face magic-front">
                  <h3 style="color:var(--sidi-blue); font-family:var(--font-display); font-size:1.4rem; margin:0 0 8px;">${nameEn}</h3>
                  ${nameAr ? `<div style="font-size:1rem; color:var(--text-muted); direction:rtl; text-align:right;">${nameAr}</div>` : ''}
                  <div style="margin-top:8px; font-size:0.8rem; color:var(--text-muted); font-weight:600; letter-spacing:1px;">TAP TO FLIP</div>
                </div>
                <div class="magic-face magic-back">
                  <p style="padding:16px; margin:0; font-size:1.1rem; color:var(--text-main);">${backEn}</p>
                  ${backAr ? `<p style="padding:8px 16px 0; margin:0; font-size:1rem; color:var(--text-muted); direction:rtl; text-align:right;">${backAr}</p>` : ''}
                </div>
              </div>
            `;
            grid.appendChild(el);
          });
        } else {
          grid.innerHTML = 'No cards';
        }
      } catch (e) { notify(e.message, 'error'); }
    }

    /* Quiz */
    async function startQuiz() {
      const topic = document.getElementById('quiz-topic').value;
      const level = document.getElementById('quiz-level').value;
      const qc = document.getElementById('quiz-container');
      qc.innerHTML = 'Starting quiz...';
      try {
        const d = await api('/learning/quiz/start', 'POST', { topic, level, lang: 'en' });
        currentQuiz = { id: d.quiz_id, topic: d.topic, level: d.level, questions: d.questions };
        renderQuizQuestions();
      } catch (e) { qc.innerHTML = ''; notify(e.message, 'error'); }
    }

    function renderQuizQuestions() {
      const qc = document.getElementById('quiz-container');
      if (!currentQuiz || !currentQuiz.questions) { qc.innerHTML = ''; return; }
      qc.innerHTML = '';
      currentQuiz.questions.forEach(q => {
        const textEn = q.question || '';
        const textAr = q.question_ar || '';
        const card = document.createElement('div');
        card.className = 'quiz-card';
        card.innerHTML = `
          <div class="quiz-question">
            ${q.index + 1}. ${textEn}
            ${textAr ? `<div style="font-size:0.95rem; color:var(--text-muted); direction:rtl; text-align:right; margin-top:4px;">${textAr}</div>` : ''}
          </div>
          <input class="quiz-input" data-idx="${q.index}" placeholder="Your answer..." />
        `;
        qc.appendChild(card);
      });
      const btn = document.createElement('button');
      btn.className = 'btn-action';
      btn.style.marginTop = '16px';
      btn.textContent = 'Submit Answers';
      btn.onclick = submitQuizAnswers;
      qc.appendChild(btn);
    }

    async function submitQuizAnswers() {
      if (!currentQuiz) return;
      const inputs = document.querySelectorAll('.quiz-input');
      const answers = Array.from(inputs).map(inp => inp.value.trim());
      try {
        const d = await api(`/learning/quiz/${currentQuiz.id}/answer`, 'POST', { answers });
        const qc = document.getElementById('quiz-container');
        qc.innerHTML = `
          <div class="quiz-card" style="border-left:4px solid var(--sidi-blue);">
            <div class="quiz-question" style="font-size:1.2rem;">Score: ${(d.score*100).toFixed(0)}% (${d.correct}/${d.total})</div>
            <div style="color:var(--text-muted); font-size:0.95rem; margin-top:4px;">${d.details.length} responses recorded.</div>
          </div>
        `;
        currentQuiz = null;
        notify('Quiz submitted');
      } catch(e) { notify(e.message, 'error'); }
    }

    /* Init */
    checkAuth();
    refreshStats();
    searchMaqam();
  </script>
</body>
</html>