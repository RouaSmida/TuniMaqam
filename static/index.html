<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TuniMaqam | Sonic Heritage Engine</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,400;0,9..144,600;1,9..144,300&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="/static/style.css">


</head>
<body>

  <div class="grid-overlay"></div>

  <nav>
    <div class="logo-container" onclick="route(event, 'dashboard')">
      <svg class="logo-svg" viewBox="0 0 100 100">
        <path d="M50 10 C30 10 10 30 10 50 L10 90 L90 90 L90 50 C90 30 70 10 50 10 Z" fill="none" stroke="currentColor" stroke-width="6"/>
        <path d="M50 20 C65 20 75 35 75 50 L75 90 L25 90 L25 50 C25 35 35 20 50 20 Z" fill="currentColor" opacity="0.3"/>
        <circle cx="50" cy="50" r="10" fill="currentColor"/>
      </svg>
      <span>TuniMaqam</span>
    </div>
    <div class="nav-links">
      <button class="nav-btn active" onclick="route(event,'dashboard')">Dashboard</button>
      <button class="nav-btn" onclick="route(event,'knowledge')">Knowledge</button>
      <button class="nav-btn" onclick="route(event,'analysis')">Analysis</button>
      <button class="nav-btn" onclick="route(event,'learning')">Learning</button>
      <button class="nav-btn" onclick="route(event,'recommendation')">Recommendation</button>
    </div>
  </nav>

  <main>
    <!-- DASHBOARD VIEW -->
    <section id="dashboard" class="section active">
      <header style="text-align:center; margin-bottom: 60px;">
        <h1 style="font-size: 3.5rem; letter-spacing: -1px; line-height: 1.1; margin-bottom: 20px;">
          PRESERVE<br><span style="color:var(--tunis-gold); font-style: italic;">THE RESONANCE</span>
        </h1>
        <p style="font-size: 1.2rem; max-width: 650px; margin: 0 auto; color: var(--text-muted); line-height: 1.6;">
          A modular API ecosystem for Tunisian Maqamet (ṭbūʿ). 
          Crowdsourced patrimony and pedagogical intelligence.
        </p>
      </header>

      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 24px;">
        <div class="glass-card">
          <h2 style="font-size:1.6rem; margin-bottom:12px; color: var(--tunis-gold);">System Access</h2>
          <div style="margin-bottom: 12px; font-size:0.9rem; color:var(--text-muted);">Initialize secure connection.</div>
          <div style="display:flex; gap: 10px; align-items:center;">
             <input id="token" type="password" placeholder="Paste JWT Token..." style="margin-bottom:0;" />
             <button class="btn-action" style="width: auto; padding: 14px 24px;" onclick="handleAuth()">Connect</button>
          </div>
          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
            <button class="btn-ghost" style="padding:10px 14px;" onclick="fetchDemoToken(true)">Load Demo Token</button>
            <span style="color:var(--text-muted); font-size:0.85rem; align-self:center;">Uses local demo JWT so games run without OAuth.</span>
          </div>
          <div id="auth-status" style="margin-top: 16px; font-weight:600; font-size:0.85rem; display:flex; align-items:center; gap:8px; color:var(--text-muted);">
            <span style="display:inline-block; width:8px; height:8px; border-radius:50%; background:#475569;"></span> 
            Offline
          </div>
        </div>

        <div class="glass-card">
          <h2 style="font-size:1.6rem; margin-bottom:16px; color: var(--tunis-gold);">Dataset Health</h2>
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px;">
             <div style="text-align:center; padding:16px; background:rgba(255,255,255,0.05); border-radius:16px; border:1px solid var(--glass-border);">
               <div style="font-size:2.5rem; font-family:var(--font-display); color:var(--text-main); line-height:1;" id="stat-maqam">0</div>
               <div style="font-size:0.7rem; font-weight:700; letter-spacing:1px; color:var(--text-muted); margin-top:8px;">MAQAMET</div>
             </div>
             <div style="text-align:center; padding:16px; background:rgba(255,255,255,0.05); border-radius:16px; border:1px solid var(--glass-border);">
               <div style="font-size:2.5rem; font-family:var(--font-display); color:var(--tunis-rose); line-height:1;" id="stat-contrib">0</div>
               <div style="font-size:0.7rem; font-weight:700; letter-spacing:1px; color:var(--text-muted); margin-top:8px;">CONTRIBS</div>
             </div>
          </div>
          <button onclick="refreshStats()" class="btn-ghost" style="margin-top:16px; width:100%;">Sync Status</button>
        </div>
      </div>
    </section>

    <!-- ARCHIVE VIEW (Map Left / Results Right) -->
    <section id="knowledge" class="section">
      <div class="archive-container">
        <!-- RESULTS STREAM -->
        <div>
           <div style="margin-bottom: 30px;">
             <h2 style="font-size: 2.5rem; margin-bottom:8px; color: var(--text-main);">Knowledge & Cartography</h2>
             <p style="color:var(--text-muted);">Explore the canonical database of Tunisian maqamet, their emotions, usage, regions, and history. Contribute new knowledge to preserve the musical patrimony.</p>
           </div>
           
           <div style="display:flex; gap:10px; background:rgba(13,118,194,0.08); padding:8px; border-radius:12px; border:1px solid var(--glass-border); margin-bottom:24px;">
             <input id="search-input" placeholder="Search by Name..." style="flex:1; margin:0; border:none; background:transparent; box-shadow:none; color:white;" />
             <div style="width:1px; background:var(--glass-border); margin:4px 0;"></div>
             <input id="region-input" placeholder="Region..." style="width: 140px; margin:0; border:none; background:transparent; box-shadow:none; color:white;" readonly />
             <button class="btn-action" style="width:auto; padding: 10px 24px; border-radius:8px;" onclick="searchMaqam()">Scan</button>
             <button class="btn-ghost" style="width:auto; padding: 10px; border-radius:8px;" onclick="document.getElementById('region-input').value='';searchMaqam();" title="Clear Region">✕</button>
           </div>

           <div style="margin-bottom:20px;">
             <button class="btn-ghost" style="width:auto; padding:10px 20px; border:1px dashed var(--tunis-gold); color:var(--tunis-gold);" onclick="openNewMaqamForm()">+ Propose New Maqam</button>
           </div>

           <div id="maqam-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;"></div>
        </div>

        <!-- STICKY MAP -->
        <div class="map-sticky">
           <h3 style="color:var(--tunis-gold); font-size:1rem; margin-bottom:20px; text-transform:uppercase; letter-spacing:1px;">Regional Filter</h3>
           <div class="map-image">
            <div class="map-hotspot" style="left:60%; top:15%;" onclick="filterByMap('tunis')"><span class="map-label-abs">Tunis</span></div>
            <div class="map-hotspot" style="left:69%; top:30%;" onclick="filterByMap('sahel')"><span class="map-label-abs">Sahel</span></div>
            <div class="map-hotspot" style="left:54%; top:34%;" onclick="filterByMap('kairouan')"><span class="map-label-abs">Kairouan</span></div>
            <div class="map-hotspot" style="left:50%; top:60%;" onclick="filterByMap('South')"><span class="map-label-abs">South</span></div>
           </div>
           <p style="font-size:0.8rem; color:var(--text-muted); text-align:center; margin-top:20px;">Click a pin to filter archive.</p>
        </div>
      </div>
    </section>

    <!-- ANALYSIS VIEW -->

    <section id="analysis" class="section">
      <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap:24px; align-items:start;">
           <div class="glass-card">
              <h2 style="font-size:2rem; margin-bottom:8px; color:var(--tunis-gold);">Analysis & Inference</h2>
              <p style="margin-bottom:20px; color:var(--text-muted);">Identify maqamet from note sequences or audio. See confidence scores and evidence for each match.</p>
              <div class="analysis-stack">
                <div style="border-bottom:1px solid var(--glass-border); padding-bottom:20px; margin-bottom:0;">
                    <label style="font-size:0.8rem; font-weight:700; color:var(--tunis-teal); text-transform:uppercase;">Option A: Manual Notes</label>
                    <input id="an-notes" value="C, D, E, F, G" style="font-family:monospace; margin-top:8px;" />
                    <input id="an-mood" placeholder="Context (Mood)" style="margin-top:4px;" />
                    <button class="btn-action" id="btn-analyze" onclick="runAnalysis()">Analyze Sequence</button>
                </div>
                <div>
                    <label style="font-size:0.8rem; font-weight:700; color:var(--tunis-teal); text-transform:uppercase;">Option B: Audio File</label>
                    <input type="file" id="an-audio-file" style="margin-top:8px;" />
                    <button class="btn-ghost" id="btn-audio" style="width:100%" onclick="runAudioAnalysis()">Upload & Process</button>
                </div>
                <div id="analysis-output" class="analysis-output-card">Awaiting input...</div>
              </div>
           </div>
       </div>
    </section>

    <!-- RECOMMENDATION VIEW -->
    <section id="recommendation" class="section">
      <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap:24px; align-items:start;">
        <div class="glass-card">
          <h2 style="font-size:2rem; margin-bottom:8px; color:var(--tunis-gold);">Recommendation</h2>
          <p style="margin-bottom:20px; color:var(--text-muted);">Get maqam suggestions for your musical or cultural scenario. Input mood, event, region, and more to receive ranked recommendations with confidence and evidence.</p>
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
             <input id="rec-mood" placeholder="Mood (e.g. joyful, melancholic)" />
             <input id="rec-event" placeholder="Event (e.g. wedding, funeral)" />
             <input id="rec-region" placeholder="Region (e.g. tunis, sahel)" />
             <input id="rec-period" placeholder="Period (e.g. ottoman, beylical, modern)" />
          </div>
          <div style="margin:16px 0; display:flex; gap:16px;">
              <label style="color:var(--text-main); font-size:0.9rem;"><input type="checkbox" id="rec-heritage"> Preserve Heritage</label>
              <label style="color:var(--text-main); font-size:0.9rem;"><input type="checkbox" id="rec-simple"> Beginner Friendly</label>
          </div>
          <button class="btn-action" id="rec-btn" onclick="runRecommendation()">Generate Ideas</button>
          <div id="rec-output" style="margin-top:20px;"></div>
        </div>
      </div>
    </section>

    <!-- ACADEMY VIEW (Modular Layout) -->
    <section id="learning" class="section">
      <div class="academy-grid">
        <div style="margin-bottom: 30px;">
          <h2 style="font-size: 2.5rem; margin-bottom:8px; color: var(--text-main);">Learning & Quiz</h2>
          <p style="color:var(--text-muted);">Practice with flashcards, quizzes, and games. Progress through levels and track your achievements.</p>
        </div>
        <!-- MODULE 1: PRACTICE GAMES (Arcade) -->
        <div>
           <span class="section-label">Interactive Labs</span>
           <h2 style="font-size:2rem; color:var(--text-main); margin-bottom:20px;">Training Modules</h2>
           
           <div class="games-row">
              <!-- Flashcards is now a game card -->
              <div class="game-card" style="border-color:var(--tunis-gold);" onclick="openFlashcardsModal()">
                 <div>
                   <div class="game-title">Flashcards</div>
                   <div class="game-desc">Full deck grid view.</div>
                 </div>
                 <div class="play-arrow">▶</div>
              </div>

              <div class="game-card" onclick="runMCQ()">
                 <div>
                   <div class="game-title">Speed MCQ</div>
                   <div class="game-desc">Rapid fire multiple choice questions.</div>
                 </div>
                 <div class="play-arrow">▶</div>
              </div>
              
              <div class="game-card" onclick="runMatching()">
                 <div>
                   <div class="game-title">Matching</div>
                   <div class="game-desc">Select pairs, then check.</div>
                 </div>
                 <div class="play-arrow">▶</div>
              </div>

              <div class="game-card" onclick="runAudioMCQ()">
                 <div>
                   <div class="game-title">Ear Training</div>
                   <div class="game-desc">Listen then pick the maqam.</div>
                 </div>
                 <div class="play-arrow">▶</div>
              </div>

              <div class="game-card" onclick="runClueGame()">
                 <div>
                   <div class="game-title">Detective</div>
                   <div class="game-desc">Enter your guess; case-insensitive.</div>
                 </div>
                 <div class="play-arrow">▶</div>
              </div>

              <div class="game-card" onclick="runOrderNotes()">
                 <div>
                   <div class="game-title">Sequencer</div>
                   <div class="game-desc">Drag to order, then submit.</div>
                 </div>
                 <div class="play-arrow">▶</div>
              </div>
           </div>
        </div>

        <!-- MODULE 2: PROGRESS & COMMUNITY -->
        <div>
           <span class="section-label">Progress & Community</span>
           <h2 style="font-size:2rem; color:var(--text-main); margin-bottom:20px;">Track & Connect</h2>
           
           <div class="games-row">
              <div class="game-card" onclick="showLeaderboard()">
                 <div>
                    <div class="game-title">Leaderboard</div>
                    <div class="game-desc">Best scores across quizzes.</div>
                 </div>
                 <div class="play-arrow">▶</div>
              </div>

              <div class="game-card" onclick="showTopContributors()">
                 <div>
                    <div class="game-title">Top Contributors</div>
                    <div class="game-desc">Users with most accepted contributions.</div>
                 </div>
                 <div class="play-arrow">▶</div>
              </div>

              <div class="game-card" onclick="showRecentActivity()">
                 <div>
                   <div class="game-title">Recent Activity</div>
                   <div class="game-desc">Your latest completions.</div>
                 </div>
                 <div class="play-arrow">▶</div>
              </div>
           </div>
        </div>

        <!-- MODULE 3: ASSESSMENT (Quiz) -->
        <div class="glass-card" style="border-left:4px solid var(--tunis-rose); background: linear-gradient(90deg, rgba(244, 63, 94, 0.05), transparent);">
           <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:20px; margin-bottom:20px;">
              <div>
                <span class="section-label" style="color:var(--tunis-rose)">Final Assessment</span>
                <h2 style="font-size:2rem; color:var(--text-main); margin-bottom:8px;">Mastery Exam</h2>
                <p style="color:var(--text-muted); max-width:500px;">20 mixed questions with 20-minute time limit.</p>
              </div>
              <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
                 <button class="btn-action" style="width:auto; padding: 12px 24px; background: var(--tunis-rose); color:white;" onclick="startQuiz()">Start Exam</button>
              </div>
           </div>
           <div id="quiz-container"></div>
        </div>

      </div>
    </section>
  </main>

  <!-- MODAL -->
  <div class="modal" id="modal">
    <div class="modal-content">
      <div class="modal-close" onclick="closeModal()">✕</div>
      <div id="modal-body"></div>
    </div>
  </div>

  <div class="toaster" id="toaster"></div>


</div>
  <script src="/static/main.js"></script>
</body>
</html>